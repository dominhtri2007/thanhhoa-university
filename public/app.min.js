const socket = io();
let chartRevenue, chartWeekly, chartHourly;
function updateChartRevenue(data) {
  const daily = {};
  data.forEach(m => {
const date = new Date(m.timestamp).toLocaleDateString("vi-VN");
const amount = parseInt(m.fields.find(f => f.name.includes("sá»‘ tiá»n"))?.value || 0, 10);
daily[date] = (daily[date] || 0) + amount;
  });
  const labels = Object.keys(daily);
  const values = labels.map(l => daily[l]);
  const ctx = document.getElementById("chartRevenue").getContext("2d");
  if (!chartRevenue) {
chartRevenue = new Chart(ctx, {
  type: "line",
  data: { labels, datasets: [{ label: "Doanh thu theo ngÃ y", data: values, borderColor: "#3a82f7", backgroundColor: "rgba(58,130,247,0.2)", fill: true, tension: 0.2 }] },
  options: { scales: { x: { ticks: { color: "#fff" }, grid: { color: "#333" } }, y: { ticks: { color: "#fff" }, grid: { color: "#333" } } } }
});
  } else {
chartRevenue.data.labels = labels;
chartRevenue.data.datasets[0].data = values;
chartRevenue.update();
  }
}
function updateChartWeekly(data) {
  const weekly = {};
  const now = new Date();
  const sevenDaysAgo = new Date();
  sevenDaysAgo.setDate(now.getDate() - 6);
  data.forEach(m => {
const date = new Date(m.timestamp);
if (date >= sevenDaysAgo && date <= now) {
  const key = date.toLocaleDateString("vi-VN");
  const amount = parseInt(m.fields.find(f => f.name.includes("sá»‘ tiá»n"))?.value || 0, 10);
  weekly[key] = (weekly[key] || 0) + amount;
}
  });
  const labels = Object.keys(weekly);
  const values = labels.map(l => weekly[l]);
  const ctx = document.getElementById("chartWeekly").getContext("2d");
  if (!chartWeekly) {
chartWeekly = new Chart(ctx, {
  type: "bar",
  data: { labels, datasets: [{ label: "Doanh thu 7 ngÃ y gáº§n nháº¥t", data: values, backgroundColor: "rgba(58,130,247,0.6)" }] },
  options: { scales: { x: { ticks: { color: "#fff" }, grid: { color: "#333" } }, y: { ticks: { color: "#fff" }, grid: { color: "#333" } } } }
});
  } else {
chartWeekly.data.labels = labels;
chartWeekly.data.datasets[0].data = values;
chartWeekly.update();
  }
}
function updateChartHourly(data) {
  const ctx = document.getElementById("chartHourly").getContext("2d");
  const labels = Array.from({ length: 24 }, (_, i) => `${i}:00`);
  if (!chartHourly) {
chartHourly = new Chart(ctx, {
  type: "bar",
  data: { labels, datasets: [{ label: "Sá»‘ tin nháº¯n theo giá»", data, backgroundColor: "rgba(255,193,7,0.6)" }] },
  options: { scales: { x: { ticks: { color: "#fff" }, grid: { color: "#333" } }, y: { ticks: { color: "#fff" }, grid: { color: "#333" } } } }
});
  } else {
chartHourly.data.datasets[0].data = data;
chartHourly.update();
  }
}
function updateTotals(data) {
  const totalRevenue = data.reduce((sum, m) => {
const amount = parseInt(m.fields.find(f => f.name.includes("sá»‘ tiá»n"))?.value || 0, 10);
return sum + amount;
  }, 0);
  document.getElementById("totalInvoices").textContent = data.length;
  document.getElementById("totalRevenue").textContent = totalRevenue.toLocaleString();
}
socket.emit("getAllInvoices");
socket.on("allInvoices", data => {
  updateChartRevenue(data);
  updateChartWeekly(data);
  updateTotals(data);
});
const today = new Date().toISOString().split("T")[0];
const daySelect = document.getElementById("daySelect");
daySelect.value = today;

function loadHourlyStats(date) {
  socket.emit("getMessageStatsByHour", { date });
}
daySelect.addEventListener("change", () => {
  loadHourlyStats(daySelect.value);
});
socket.on("messageStatsByHour", updateChartHourly);
loadHourlyStats(today);
// ---- THá»NG KÃŠ THEO KHOáº¢NG NGÃ€Y ----
document.getElementById("btnCheckRange").onclick = function () {
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;

  if (!from || !to) {
    alert("Vui lÃ²ng chá»n Ä‘á»§ ngÃ y!");
    return;
  }

  socket.emit("statistic", { senderId: null, fromDate: from, toDate: to });
};

// Nháº­n káº¿t quáº£ tá»« server
socket.on("statisticResult", ({ count, total }) => {
  const box = document.getElementById("rangeResult");

  box.innerHTML = `
    <p><b>ğŸ“Œ Tá»•ng hÃ³a Ä‘Æ¡n:</b> ${count}</p>
    <p><b>ğŸ’° Tá»•ng sá»‘ tiá»n:</b> ${total.toLocaleString()} VNÄ</p>
    <p><b>ğŸ“Š Doanh thu trung bÃ¬nh/ngÃ y:</b> ${Math.round(total / 26).toLocaleString()} VNÄ</p>
  `;
});
